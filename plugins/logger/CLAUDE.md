# CLAUDE.md - Logger Plugin

This file provides comprehensive guidance for maintaining the Claude Code Session Logger plugin.

## Plugin Architecture

The logger plugin is a **hook-based session event logger** that:

1. Compiles TypeScript to a native executable using Bun's bundler
2. Registers the executable to run on 11 different Claude Code hook events
3. Receives hook input via stdin as JSON
4. Appends structured log entries to JSONL files in `.logs/` directory
5. Manages symlinks for quick access to current and previous sessions

**Key characteristic:** Unlike other plugins in this repo (which are primarily markdown-based skills/commands), the logger plugin compiles to a native executable for performance and portability.

## Design Principles

### Session-Based Logging

- Each Claude Code session gets its own log file: `cc-session-<timestamp>-<session-id>.jsonl`
- SessionStart event creates new log file and updates `cc-session-current.jsonl` symlink
- SessionEnd event updates `cc-session-last.jsonl` symlink to point to completed session
- Log files persist indefinitely for historical analysis

### JSONL Format

- Each log entry is a single-line JSON object
- Newline-delimited for streaming, parsing, and appending
- Supports tools like `jq`, `grep`, and custom analyzers
- Each entry includes full raw hook data for debugging

### Symlink Management

- `cc-session-current.jsonl` → Always points to active session log
- `cc-session-last.jsonl` → Points to most recently completed session
- Simplifies access without needing to remember session IDs

### Non-Blocking Operation

- Logger never returns blocking output to Claude Code
- Errors are silently logged to stderr (Claude Code ignores stderr from hooks)
- Never interrupts user workflow

## Directory Structure

```
plugins/logger/
├── .claude-plugin/
│   └── plugin.json           # Plugin metadata (name: "logger")
├── bin/
│   └── session-logger        # Compiled executable (gitignored, generated by build)
├── hooks/
│   └── hooks.json            # Hook registrations for 11 events
├── scripts/
│   └── build.ts              # Bun build script (62 lines)
├── src/
│   ├── claude-hooks.ts       # TypeScript type definitions (243 lines)
│   └── session-logger.ts     # Main logger implementation (205 lines)
├── biome.json                # Plugin-specific linting config
├── package.json              # Workspace package (@claude-plugins/logger)
├── tsconfig.json             # TypeScript config extending base
├── CLAUDE.md                 # This file (maintainer guide)
└── README.md                 # User guide (brief)
```

## Component Responsibilities

### `src/session-logger.ts` (205 lines)

**Main executable entry point.**

Key functions:
- `main()`: Reads hook input from stdin, parses JSON, routes to handler
- `handleHookEvent()`: Extracts common fields, creates LogEntry, writes to file
- `getLogFilePath()`: Determines which log file to append to (session-specific)
- `ensureLogFile()`: Creates log file on first write, manages symlinks
- `updateSymlink()`: Atomic symlink creation/update for current/last pointers
- `showHelp()`: CLI help text (not typically called, hooks don't pass arguments)

**LogEntry interface:** Defines structured log format with event-specific fields:
- Common: `timestamp`, `unix_timestamp`, `event`, `session_id`, `cwd`, `transcript_path`
- Tool events: `tool_name`, `tool_input`, `tool_response`
- Event-specific: `message`, `prompt`, `stop_hook_active`, `trigger`, `source`, `reason`
- Debugging: `raw_data` (full hook input)

**Hook event handling:**
- SessionStart: Creates new log file, updates `current` symlink
- SessionEnd: Updates `last` symlink
- PreToolUse: Logs tool name and input
- PostToolUse: Logs tool name, input, and response
- PostToolUseFailure: Logs failed tool execution
- UserPromptSubmit: Logs user's prompt
- Stop/SubagentStop: Logs when Claude finishes responding
- PreCompact: Logs conversation compaction events
- Notification: Logs system notifications
- PermissionRequest: Logs permission prompts

### `src/claude-hooks.ts` (243 lines)

**Type definitions for Claude Code hook system.**

Provides TypeScript interfaces for all hook input types:
- `BaseHookInput`: Common fields (session_id, transcript_path, cwd, hook_event_name)
- `StatuslineInput`: Status bar data (model, workspace, cost, context)
- `PreToolUseInput`: Before tool execution (tool_name, tool_input)
- `PostToolUseInput`: After tool success (tool_name, tool_input, tool_response)
- `NotificationInput`: System messages
- `UserPromptSubmitInput`: User prompt text
- `StopInput`: Stop/SubagentStop events
- `PreCompactInput`: Conversation compaction
- `SessionStartInput`: Session initialization (source: startup|resume|clear|compact)
- `SessionEndInput`: Session termination (reason: clear|logout|prompt_input_exit|other)
- `PostToolUseFailureInput`: Failed tool execution
- `PermissionRequestInput`: User permission prompts

**Type guard pattern:**
```typescript
export type HookInput =
  | SessionStartInput
  | SessionEndInput
  | PreToolUseInput
  | PostToolUseInput
  | ... ;
```

Union type enables exhaustive type checking and autocomplete in IDEs.

### `scripts/build.ts` (62 lines)

**Bun-based build script that compiles TypeScript to native executable.**

Build process:
1. Detects platform and architecture (darwin-arm64, darwin-x64, linux-x64)
2. Uses `Bun.build()` with `compile` mode to create standalone binary
3. Enables minification, bytecode, and inline sourcemaps
4. Sets executable permissions (0o755)
5. Outputs to `bin/session-logger`

**Why executable vs script?**
- **Performance**: No TypeScript parsing on every hook invocation
- **Portability**: Single binary, no runtime dependencies at execution time
- **Reliability**: Bytecode compilation ensures consistent behavior

**Platform support:**
- macOS: arm64 (Apple Silicon), x64 (Intel)
- Linux: x64

Build invocation:
```bash
bun run build           # Quiet mode
bun run build:verbose   # Shows progress
```

### `hooks/hooks.json` (113 lines)

**Hook registration configuration.**

Registers `${CLAUDE_PLUGIN_ROOT}/bin/session-logger` executable for 11 events:
1. SessionStart
2. SessionEnd
3. PreToolUse
4. PostToolUse
5. PostToolUseFailure
6. UserPromptSubmit
7. Stop
8. SubagentStop
9. PreCompact
10. Notification
11. PermissionRequest

**Hook execution model:**
- Claude Code invokes executable with hook input JSON on stdin
- Executable writes log entry to JSONL file
- Executable exits (no stdout/stderr output expected)

## How the Plugin Works

### Hook Execution Flow

```
Claude Code Event
    ↓
Claude Code Hook System
    ↓
Execute: ${CLAUDE_PLUGIN_ROOT}/bin/session-logger
    ↓
Pass JSON via stdin: {"hook_event_name": "...", "session_id": "...", ...}
    ↓
session-logger.ts main()
    ↓
Parse JSON → HookInput
    ↓
handleHookEvent(hookInput)
    ↓
Create LogEntry with extracted fields
    ↓
getLogFilePath(session_id) → .logs/cc-session-<timestamp>-<session-id>.jsonl
    ↓
ensureLogFile() → Create file if needed, update symlinks
    ↓
appendFile() → Write JSON line to JSONL
```

### Session Lifecycle

1. **Session Start:**
   - User launches Claude Code or resumes session
   - SessionStart hook fires with `source` field (startup|resume|clear|compact)
   - Logger creates new log file: `.logs/cc-session-2026-02-03-14-30-00-abc123.jsonl`
   - Logger updates symlink: `.logs/cc-session-current.jsonl` → new file

2. **During Session:**
   - Every hook event appends one JSONL line to current session log
   - Tool use events log tool name, input, output
   - User prompts logged to understand conversation flow
   - Stop events mark end of Claude's response

3. **Session End:**
   - User exits Claude Code or clears session
   - SessionEnd hook fires with `reason` field (clear|logout|prompt_input_exit|other)
   - Logger updates symlink: `.logs/cc-session-last.jsonl` → completed file
   - Log file persists for analysis

### Symlink Strategy

**Current session:**
```bash
ls -la .logs/cc-session-current.jsonl
# → .logs/cc-session-2026-02-03-14-30-00-abc123.jsonl
```

**Previous session:**
```bash
ls -la .logs/cc-session-last.jsonl
# → .logs/cc-session-2026-02-02-10-15-00-xyz789.jsonl
```

**Benefits:**
- Quick access without remembering session IDs
- Scripts can always read "current" session
- Historical analysis of "last" session

## Common Maintenance Tasks

### Adding New Hook Types

If Claude Code adds new hook events:

1. **Add type definition** in `src/claude-hooks.ts`:
   ```typescript
   export interface NewHookInput extends BaseHookInput {
     hook_event_name: "NewHook";
     new_field: string;
   }
   ```

2. **Add to union type**:
   ```typescript
   export type HookInput =
     | SessionStartInput
     | ...
     | NewHookInput;
   ```

3. **Register in hooks.json**:
   ```json
   "NewHook": [
     {
       "hooks": [
         {
           "type": "command",
           "command": "${CLAUDE_PLUGIN_ROOT}/bin/session-logger"
         }
       ]
     }
   ]
   ```

4. **Rebuild executable:**
   ```bash
   bun run build
   ```

5. **Test new hook:**
   ```bash
   echo '{"hook_event_name":"NewHook","session_id":"test","cwd":"'$(pwd)'","transcript_path":"test.txt","new_field":"value"}' | ./bin/session-logger
   cat .logs/cc-session-current.jsonl
   ```

### Updating Type Definitions

When Claude Code changes hook input schemas:

1. Update interface in `src/claude-hooks.ts`
2. Update `LogEntry` interface in `src/session-logger.ts` if new fields should be logged
3. Update `handleHookEvent()` to extract new fields
4. Rebuild: `bun run build`
5. Test with updated JSON

### Rebuilding Executables

When to rebuild:
- After code changes in `src/`
- After dependency updates
- When targeting new platform

**Standard rebuild:**
```bash
cd plugins/logger
bun run build
```

**Verbose rebuild (shows compilation details):**
```bash
bun run build:verbose
```

**Verify executable:**
```bash
file bin/session-logger
# → bin/session-logger: Mach-O 64-bit executable arm64
```

### Managing Log File Formats

**JSONL advantages:**
- Streamable: Can append without reading entire file
- Parseable: Each line is valid JSON
- Tooling: Works with `jq`, `grep`, custom scripts

**Example queries:**

All tool uses in current session:
```bash
grep '"event":"PreToolUse"' .logs/cc-session-current.jsonl | jq .
```

Count events by type:
```bash
jq -r .event .logs/cc-session-current.jsonl | sort | uniq -c
```

Extract user prompts:
```bash
jq -r 'select(.event=="UserPromptSubmit") | .prompt' .logs/cc-session-current.jsonl
```

Session duration:
```bash
head -1 .logs/cc-session-current.jsonl | jq .timestamp
tail -1 .logs/cc-session-current.jsonl | jq .timestamp
```

## Architecture Rationale

### Why Executable Instead of Script?

**Performance:**
- Hooks fire frequently (every tool use, every prompt)
- No TypeScript parsing overhead on each invocation
- Bytecode compilation ensures fast startup

**Portability:**
- Single binary, no runtime dependencies at execution time
- Users don't need TypeScript/Bun installed to run (only to build)
- Consistent behavior across environments

**Reliability:**
- Compiled code reduces runtime errors
- Type checking at build time, not execution time

**Trade-off:**
- Requires rebuilding after code changes
- Platform-specific binaries (not cross-platform)
- Larger file size than script

### Why JSONL Instead of JSON Array?

**Streaming:**
- Can append to file without reading/parsing entire file
- No need to close array bracket (session may end unexpectedly)

**Robustness:**
- If process crashes, previous entries are valid
- JSON array would be invalid without closing bracket

**Parsing:**
- Tools can process line-by-line (low memory usage)
- Easy to grep, filter, split

**Trade-off:**
- Not valid JSON as whole file (each line is valid JSON)
- Requires line-by-line parsing

### Why Symlinks for Current/Last Session?

**User Experience:**
- Don't need to remember session IDs
- Quick access: `cat .logs/cc-session-current.jsonl`

**Scripting:**
- Predictable paths for automation
- Monitor current session in real-time

**Implementation:**
- Atomic updates (rename temporary symlink)
- No race conditions

**Trade-off:**
- Symlinks not universally supported (Windows requires admin/developer mode)
- Could use file copy instead, but wastes space

## Testing the Plugin

### Manual Hook Testing

The compiled executable can be tested directly by piping JSON to stdin.

**Test SessionStart:**
```bash
cd plugins/logger
echo '{"hook_event_name":"SessionStart","session_id":"test-001","cwd":"'$(pwd)'","transcript_path":"/tmp/test.jsonl","source":"startup"}' | ./bin/session-logger
```

**Verify log created:**
```bash
ls .logs/
cat .logs/cc-session-current.jsonl
```

**Test PreToolUse:**
```bash
echo '{"hook_event_name":"PreToolUse","session_id":"test-001","cwd":"'$(pwd)'","transcript_path":"/tmp/test.jsonl","tool_name":"Bash","tool_input":{"command":"ls"}}' | ./bin/session-logger
```

**Test PostToolUse:**
```bash
echo '{"hook_event_name":"PostToolUse","session_id":"test-001","cwd":"'$(pwd)'","transcript_path":"/tmp/test.jsonl","tool_name":"Bash","tool_input":{"command":"ls"},"tool_response":{"output":"file1\nfile2"}}' | ./bin/session-logger
```

**Test UserPromptSubmit:**
```bash
echo '{"hook_event_name":"UserPromptSubmit","session_id":"test-001","cwd":"'$(pwd)'","transcript_path":"/tmp/test.jsonl","prompt":"hello world"}' | ./bin/session-logger
```

**Test SessionEnd:**
```bash
echo '{"hook_event_name":"SessionEnd","session_id":"test-001","cwd":"'$(pwd)'","transcript_path":"/tmp/test.jsonl","reason":"logout"}' | ./bin/session-logger
```

**Verify multiple entries:**
```bash
cat .logs/cc-session-current.jsonl | jq .event
# Should show: "SessionStart", "PreToolUse", "PostToolUse", "UserPromptSubmit", "SessionEnd"
```

**Verify last session symlink:**
```bash
ls -la .logs/cc-session-last.jsonl
# Should point to test-001 log file
```

### Automated Testing

Create test script `scripts/test-hooks.sh`:

```bash
#!/usr/bin/env bash
set -e

SESSION_ID="test-$(date +%s)"
CWD=$(pwd)
TRANSCRIPT="/tmp/test-transcript.jsonl"

echo "Testing logger with session: $SESSION_ID"

# Test each hook type
./bin/session-logger <<EOF
{"hook_event_name":"SessionStart","session_id":"$SESSION_ID","cwd":"$CWD","transcript_path":"$TRANSCRIPT","source":"startup"}
EOF

./bin/session-logger <<EOF
{"hook_event_name":"UserPromptSubmit","session_id":"$SESSION_ID","cwd":"$CWD","transcript_path":"$TRANSCRIPT","prompt":"test prompt"}
EOF

./bin/session-logger <<EOF
{"hook_event_name":"PreToolUse","session_id":"$SESSION_ID","cwd":"$CWD","transcript_path":"$TRANSCRIPT","tool_name":"Read","tool_input":{"file_path":"test.txt"}}
EOF

./bin/session-logger <<EOF
{"hook_event_name":"PostToolUse","session_id":"$SESSION_ID","cwd":"$CWD","transcript_path":"$TRANSCRIPT","tool_name":"Read","tool_input":{"file_path":"test.txt"},"tool_response":{"content":"test content"}}
EOF

./bin/session-logger <<EOF
{"hook_event_name":"SessionEnd","session_id":"$SESSION_ID","cwd":"$CWD","transcript_path":"$TRANSCRIPT","reason":"logout"}
EOF

# Verify log entries
echo "Verifying log entries..."
ENTRY_COUNT=$(cat .logs/cc-session-current.jsonl | wc -l)
if [ "$ENTRY_COUNT" -eq 5 ]; then
  echo "✅ All 5 events logged successfully"
else
  echo "❌ Expected 5 entries, found $ENTRY_COUNT"
  exit 1
fi

echo "✅ Logger tests passed"
```

Run tests:
```bash
cd plugins/logger
chmod +x scripts/test-hooks.sh
./scripts/test-hooks.sh
```

### Integration Testing

Test with real Claude Code session:

1. **Install plugin:**
   ```bash
   claude plugin install ./plugins/logger --scope user
   ```

2. **Start Claude Code session:**
   ```bash
   claude
   ```

3. **Verify logging:**
   ```bash
   cat .logs/cc-session-current.jsonl | jq .event
   # Should show SessionStart
   ```

4. **Perform actions in Claude Code:**
   - Submit a prompt
   - Wait for tool use
   - Stop generation
   - Exit session

5. **Verify log completeness:**
   ```bash
   cat .logs/cc-session-current.jsonl | jq .event
   # Should show sequence: SessionStart, UserPromptSubmit, PreToolUse, PostToolUse, Stop, SessionEnd
   ```

## Common Pitfalls

### Platform-Specific Builds

**Problem:** Executable built on macOS won't run on Linux

**Solution:** Build on target platform or use cross-compilation (not yet supported by Bun)

**Workaround:** Build separate binaries for each platform, distribute as tarballs

### Bun API Changes

**Problem:** `Bun.build()` API may change between Bun versions

**Symptoms:**
- Build script fails with "unknown option" error
- Compiled executable doesn't run

**Solution:** Check Bun changelog, update `scripts/build.ts` API usage

**Current API (Bun 1.0+):**
```typescript
await Bun.build({
  entrypoints: [SRC_FILE],
  compile: {
    target: "bun-darwin-arm64",
    outfile: DEST_FILE,
  },
  minify: true,
  bytecode: true,
  sourcemap: "inline",
});
```

### Hook Input Contract Changes

**Problem:** Claude Code changes hook input schema, logger crashes

**Symptoms:**
- Log entries stop appearing
- Missing fields in log entries
- Type errors during rebuild

**Solution:**
1. Review Claude Code release notes for hook schema changes
2. Update types in `src/claude-hooks.ts`
3. Update log entry extraction in `src/session-logger.ts`
4. Rebuild executable
5. Test with new schema

### Symlink Permissions

**Problem:** Symlink creation fails on some systems (Windows)

**Symptoms:**
- Log entries written but symlinks missing
- Error: "operation not permitted"

**Solution:**
- Windows: Enable Developer Mode or run as Administrator
- Alternative: Use file copies instead of symlinks (modify `updateSymlink()`)

### Log File Growth

**Problem:** `.logs/` directory grows unbounded

**Current behavior:** All log files persist indefinitely

**Future enhancement:** Add log rotation/cleanup script
- Keep last N sessions
- Archive old sessions to compressed format
- Clean logs older than X days

**Manual cleanup:**
```bash
# Keep only last 10 sessions
ls -t .logs/cc-session-*.jsonl | tail -n +11 | xargs rm

# Keep only last 7 days
find .logs -name "cc-session-*.jsonl" -mtime +7 -delete
```

## Related Documentation

**Claude Code:**
- [Hooks documentation](https://github.com/anthropics/claude-code/docs/hooks.md)
- [Plugin system](https://github.com/anthropics/claude-code/docs/plugins.md)

**Bun:**
- [Bun.build API](https://bun.sh/docs/bundler)
- [Compile executable](https://bun.sh/docs/bundler/executables)

**JSONL Format:**
- [JSONL spec](https://jsonlines.org/)

**Project:**
- `README.md` - User quick start guide
- `lib/CLAUDE.md` - Shared library utilities
- Root `CLAUDE.md` - Plugin development standards
